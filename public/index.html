<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Envía tu Postal Personalizada</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Federo&display=swap" rel="stylesheet">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const Upload = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    function PostcardApp() {
      const [customImage, setCustomImage] = useState(null);
      const [message, setMessage] = useState('');
      const [submitted, setSubmitted] = useState(false);
      const [sending, setSending] = useState(false);
      const [error, setError] = useState('');

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => setCustomImage(event.target.result);
          reader.readAsDataURL(file);
        }
      };

      // Genera la imagen del dorso con el texto usando canvas
      const createBackImage = (text) => {
        const canvas = document.createElement('canvas');
        // Tamaño aproximado A5 landscape en píxeles
        canvas.width = 1748;
        canvas.height = 1240;

        const ctx = canvas.getContext('2d');

        // Fondo blanco
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Texto negro
        ctx.fillStyle = '#000000';
        ctx.font = '32px Arial';

        const margin = 100;
        const maxWidth = canvas.width - margin * 2;
        const lineHeight = 42;

        const words = text.split(' ');
        let line = '';
        let y = margin;

        for (let i = 0; i < words.length; i++) {
          const testLine = line + words[i] + ' ';
          const testWidth = ctx.measureText(testLine).width;

          if (testWidth > maxWidth && i > 0) {
            ctx.fillText(line, margin, y);
            line = words[i] + ' ';
            y += lineHeight;
          } else {
            line = testLine;
          }
        }

        if (line) {
          ctx.fillText(line, margin, y);
        }

        // Devuelve un dataURL JPEG
        return canvas.toDataURL('image/jpeg', 0.9);
      };

      const handleSubmit = async () => {
        if (customImage && message) {
          setSending(true);
          setError('');

          try {
            // Generamos la imagen del reverso con el mensaje
            const backImage = createBackImage(message);

            const response = await fetch('/api/send-postcard', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image: customImage,
                message: message,
                backImage: backImage
              })
            });

            const data = await response.json();

            if (response.ok) {
              setSubmitted(true);
            } else {
              setError(data.error || 'Error al enviar la postal');
              setSending(false);
            }
          } catch (err) {
            setError('Error de conexión. Intenta de nuevo.');
            setSending(false);
          }
        }
      };

      if (submitted) {
        return (
          <div style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #FFE5E5 0%, #E5F3FF 25%, #FFF5E5 50%, #E5FFE5 75%, #F5E5FF 100%)',
            backgroundSize: '400% 400%',
            animation: 'gradient 15s ease infinite'
          }}>
            <style>{`
              @keyframes gradient {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
              }
            `}</style>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
              <div style={{
                display: 'inline-block',
                padding: '1rem 3rem',
                background: 'white',
                borderRadius: '9999px',
                marginBottom: '2.5rem'
              }}>
                <h1 style={{
                  fontSize: '1.5rem',
                  fontWeight: 'bold',
                  color: '#A8D8EA'
                }}>¡Tu postal fue enviada!</h1>
              </div>

              <div style={{
                display: 'inline-block',
                transform: 'rotate(8deg)',
                background: 'white',
                padding: '0.75rem',
                boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'
              }}>
                <div style={{
                  width: '300px',
                  height: '200px',
                  backgroundImage: customImage ? `url(${customImage})` : 'none',
                  backgroundColor: '#E5D4B8',
                  backgroundSize: 'cover',
                  backgroundPosition: 'center',
                  borderRadius: '0.25rem'
                }}></div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          background: 'linear-gradient(135deg, #FFE5E5 0%, #E5F3FF 25%, #FFF5E5 50%, #E5FFE5 75%, #F5E5FF 100%)',
          backgroundSize: '400% 400%',
          animation: 'gradient 15s ease infinite'
        }}>
          <style>{`
            @keyframes gradient {
              0% { background-position: 0% 50%; }
              50% { background-position: 100% 50%; }
              100% { background-position: 0% 50%; }
            }
          `}</style>
          <div style={{
            background: 'white',
            borderRadius: '1.5rem',
            padding: '2rem',
            maxWidth: '28rem',
            width: '100%',
            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.07)'
          }}>
            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
              <h1 style={{ fontSize: '1.875rem', fontWeight: 'bold', color: '#111827', marginBottom: '0.5rem' }}>
                Envía tu postal
              </h1>
              <p style={{ color: '#6B7280' }}>Subí tu imagen y escribí tu mensaje ✨</p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
              {error && (
                <div style={{
                  background: '#FEE2E2',
                  border: '1px solid #FCA5A5',
                  borderRadius: '1rem',
                  padding: '1rem'
                }}>
                  <p style={{ color: '#991B1B', fontSize: '0.875rem' }}>{error}</p>
                </div>
              )}

              {/* Upload Image */}
              <div>
                <label style={{ display: 'block', fontSize: '0.875rem', fontWeight: '600', color: '#374151', marginBottom: '0.5rem' }}>
                  Tu Imagen
                </label>
                <div style={{
                  border: '2px dashed #D1D5DB',
                  borderRadius: '1rem',
                  padding: '1.5rem',
                  textAlign: 'center',
                  cursor: 'pointer'
                }}>
                  {customImage ? (
                    <div>
                      <img src={customImage} alt="Preview" style={{
                        width: '100%',
                        height: '12rem',
                        objectFit: 'cover',
                        borderRadius: '0.5rem',
                        marginBottom: '0.75rem'
                      }} />
                      <label style={{
                        cursor: 'pointer',
                        display: 'inline-block',
                        padding: '0.5rem 1.5rem',
                        background: 'black',
                        color: 'white',
                        borderRadius: '9999px',
                        fontSize: '0.875rem'
                      }}>
                        Cambiar imagen
                        <input type="file" accept="image/*" onChange={handleImageUpload} style={{ display: 'none' }} />
                      </label>
                    </div>
                  ) : (
                    <label style={{ cursor: 'pointer' }}>
                      <Upload />
                      <p style={{ color: '#6B7280', marginBottom: '0.25rem', fontWeight: '500' }}>Subir imagen</p>
                      <p style={{ fontSize: '0.75rem', color: '#9CA3AF' }}>PNG o JPEG (máx. 5MB)</p>
                      <input type="file" accept="image/*" onChange={handleImageUpload} style={{ display: 'none' }} />
                    </label>
                  )}
                </div>
              </div>

              {/* Message */}
              <div>
                <label style={{ display: 'block', fontSize: '0.875rem', fontWeight: '600', color: '#374151', marginBottom: '0.5rem' }}>
                  Tu Mensaje
                </label>
                <textarea
                  value={message}
                  onChange={(e) => setMessage(e.target.value)}
                  placeholder="Escribe tu mensaje aquí..."
                  rows="4"
                  style={{
                    width: '100%',
                    border: '1px solid #D1D5DB',
                    borderRadius: '1rem',
                    padding: '0.75rem 1rem',
                    outline: 'none',
                    fontFamily: 'Helvetica, Arial, sans-serif',
                    resize: 'none'
                  }}
                />
              </div>

              {/* Submit Button */}
              <button
                onClick={handleSubmit}
                disabled={!customImage || !message || sending}
                style={{
                  width: '100%',
                  padding: '1rem',
                  borderRadius: '9999px',
                  fontWeight: '600',
                  color: 'white',
                  background: (customImage && message && !sending) ? 'black' : '#D1D5DB',
                  cursor: (customImage && message && !sending) ? 'pointer' : 'not-allowed',
                  border: 'none'
                }}
              >
                {sending ? 'Enviando...' : 'Enviar Postal'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<PostcardApp />, document.getElementById('root'));
  </script>
</body>
</html>
