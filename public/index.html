<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Env√≠a tu Postal Personalizada</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Federo&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    function Upload() {
      return (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className="mx-auto mb-2"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      );
    }

    function PostcardApp() {
      const [customImage, setCustomImage] = useState(null);
      const [message, setMessage] = useState("");
      const [address, setAddress] = useState({
        name: "",
        street: "",
        city: "",
        postalCode: "",
      });
      const [submitted, setSubmitted] = useState(false);
      const [sending, setSending] = useState(false);
      const [error, setError] = useState("");

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const maxFileSizeMB = 3;
        if (file.size > maxFileSizeMB * 1024 * 1024) {
          setError(`La imagen es demasiado grande (m√°x ${maxFileSizeMB}MB).`);
          return;
        }

        setError("");

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const maxWidth = 1000;
            const scale = Math.min(1, maxWidth / img.width);

            const canvas = document.createElement("canvas");
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const compressedDataUrl = canvas.toDataURL("image/jpeg", 0.6);

            console.log("üìâ Tama√±o dataURL comprimida:", compressedDataUrl.length, "caracteres");
            setCustomImage(compressedDataUrl);
          };

          img.onerror = () => {
            setError("No se pudo procesar la imagen.");
          };

          img.src = event.target.result;
        };

        reader.onerror = () => {
          setError("Error al leer la imagen.");
        };

        reader.readAsDataURL(file);
      };

      const handleSubmit = async () => {
        if (
          !customImage ||
          !message ||
          !address.name ||
          !address.street ||
          !address.city ||
          !address.postalCode
        ) {
          return;
        }

        setSending(true);
        setError("");

        if (customImage && customImage.length > 3000000) {
          setError(
            "La imagen sigue siendo muy pesada despu√©s de comprimir. Prob√° con una m√°s peque√±a."
          );
          setSending(false);
          return;
        }

        try {
          const payload = {
            image: customImage,
            message: message,
            address: address,
          };

          console.log("üì§ Enviando payload:", payload);

          const response = await fetch("/api/send-postcard", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          console.log("üì• Respuesta cruda de la API:", text);
          console.log("üì° Status:", response.status);

          let data = null;
          try {
            data = JSON.parse(text);
          } catch (parseErr) {
            console.error("‚ö†Ô∏è Error parseando JSON:", parseErr);
          }

          if (!response.ok) {
            console.error("‚ùå Error desde la API:", data);
            setError((data && data.error) || "Error al enviar la postal");
            setSending(false);
            return;
          }

          console.log("‚úÖ Postal enviada correctamente:", data);
          setSubmitted(true);
        } catch (err) {
          console.error("üö® Error en fetch:", err);
          setError("Error de conexi√≥n. Intenta de nuevo.");
          setSending(false);
        }
      };

      if (submitted) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-rose-100 via-sky-100 to-emerald-100">
            <div className="flex flex-col items-center space-y-8">
              <div className="px-8 py-3 bg-white rounded-full shadow">
                <h1 className="text-lg font-bold text-sky-400">
                  ¬°Tu postal fue enviada!
                </h1>
              </div>
              <div className="bg-white p-2 shadow-xl rotate-3">
                <div
                  className="w-72 h-48 rounded bg-cover bg-center"
                  style={{
                    backgroundImage: customImage
                      ? `url(${customImage})`
                      : "none",
                    backgroundColor: customImage ? "transparent" : "#E5D4B8",
                  }}
                ></div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-rose-100 via-sky-100 to-emerald-100 p-6">
          <div className="bg-white rounded-3xl shadow-lg max-w-md w-full p-6 space-y-6">
            <div className="text-center space-y-1">
              <h1 className="text-2xl font-bold text-gray-900">
                Env√≠a tu postal
              </h1>
              <p className="text-sm text-gray-500">
                Completa los datos y sube tu imagen
              </p>
            </div>

            {error && (
              <div className="bg-red-100 border border-red-300 text-red-800 rounded-2xl px-4 py-3 text-sm">
                {error}
              </div>
            )}

            {/* Imagen */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Tu imagen
              </label>
              <div className="border-2 border-dashed border-gray-300 rounded-2xl p-4 text-center cursor-pointer">
                {customImage ? (
                  <div>
                    <img
                      src={customImage}
                      alt="Preview"
                      className="w-full h-48 object-cover rounded-lg mb-3"
                    />
                    <label className="inline-block px-4 py-2 bg-black text-white rounded-full text-sm cursor-pointer">
                      Cambiar imagen
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleImageUpload}
                        className="hidden"
                      />
                    </label>
                  </div>
                ) : (
                  <label className="cursor-pointer flex flex-col items-center">
                    <Upload />
                    <p className="text-gray-600 font-medium mb-1">
                      Subir imagen
                    </p>
                    <p className="text-xs text-gray-400">
                      PNG o JPEG (m√°x. 5MB)
                    </p>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      className="hidden"
                    />
                  </label>
                )}
              </div>
            </div>

            {/* Mensaje */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Tu mensaje
              </label>
              <textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder="Escribe tu mensaje aqu√≠..."
                rows={4}
                className="w-full border border-gray-300 rounded-2xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black focus:border-black"
              />
            </div>

            {/* Direcci√≥n */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Direcci√≥n de env√≠o
              </label>
              <div className="space-y-2">
                <input
                  type="text"
                  value={address.name}
                  onChange={(e) =>
                    setAddress({ ...address, name: e.target.value })
                  }
                  placeholder="Nombre completo"
                  className="w-full border border-gray-300 rounded-2xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black focus:border-black"
                />
                <input
                  type="text"
                  value={address.street}
                  onChange={(e) =>
                    setAddress({ ...address, street: e.target.value })
                  }
                  placeholder="Direcci√≥n"
                  className="w-full border border-gray-300 rounded-2xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black focus:border-black"
                />
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    value={address.city}
                    onChange={(e) =>
                      setAddress({ ...address, city: e.target.value })
                    }
                    placeholder="Ciudad"
                    className="w-full border border-gray-300 rounded-2xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black focus:border-black"
                  />
                  <input
                    type="text"
                    value={address.postalCode}
                    onChange={(e) =>
                      setAddress({ ...address, postalCode: e.target.value })
                    }
                    placeholder="C√≥digo Postal"
                    className="w-full border border-gray-300 rounded-2xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black focus:border-black"
                  />
                </div>
              </div>
            </div>

            {/* Bot√≥n */}
            <button
              onClick={handleSubmit}
              disabled={
                !customImage ||
                !message ||
                !address.name ||
                !address.street ||
                !address.city ||
                !address.postalCode ||
                sending
              }
              className={`w-full py-3 rounded-full font-semibold text-sm text-white ${
                customImage &&
                message &&
                address.name &&
                address.street &&
                address.city &&
                address.postalCode &&
                !sending
                  ? "bg-black cursor-pointer"
                  : "bg-gray-300 cursor-not-allowed"
              }`}
            >
              {sending ? "Enviando..." : "Enviar postal"}
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<PostcardApp />, document.getElementById("root"));
  </script>
</body>
</html>
